<!DOCTYPE html>
<html>
<head>
    <title>Asset Dashboard</title>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <style>
        .type-badge {
            display: inline-block;
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            line-height: 1;
        }
        .type-ME { background: #e7f3ff; color: #084298; }
        .type-EE { background: #e6ffed; color: #0a6b2d; }
        .type-EL { background: #fff3cd; color: #664d03; }
        .type-PL { background: #fde2e2; color: #842029; }
        .type-HV { background: #e8e6ff; color: #3d2b8c; }
        .type-OTHER { background: #f1f3f5; color: #333; }

        .filters-bar .form-select { min-width: 220px; }
        .filters-bar .badge { font-weight: 500; }
    </style>
</head>
<body class="container-fluid py-4">

    <div class="d-flex justify-content-start align-items-center mb-4">
        <a href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='ubc-logo.png') }}" alt="UBC Logo" style="height: 72px; margin-right: 16px;">
        </a>
        <a href="{{ url_for('index') }}" style="text-decoration: none; color: black;">
            <h1 class="m-0">Asset Review Dashboard</h1>
        </a>
    </div>

    <!-- Quick filters -->
    <div class="filters-bar row g-3 align-items-center mb-3">
        <div class="col-auto">
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm px-3 {% if not flagged_filter and not modified_filter and not missed_filter %}active{% endif %}">All</a>
            <a href="{{ url_for('index', flagged='true') }}" class="btn btn-outline-danger btn-sm px-3 {% if flagged_filter == 'true' %}active{% endif %}">
                üö© Flagged Only <span class="badge bg-light text-dark" style="min-width: 40px;">{{ count_flagged }}</span>
            </a>
            <a href="{{ url_for('index', modified='true') }}" class="btn btn-outline-warning btn-sm px-3 {% if modified_filter == 'true' %}active{% endif %}">
                ‚úèÔ∏è Modified Only <span class="badge bg-light text-dark" style="min-width: 40px;">{{ count_modified }}</span>
            </a>
            <a href="{{ url_for('index', missed='true') }}" class="btn btn-outline-dark btn-sm px-3 {% if missed_filter == 'true' %}active{% endif %}">
                ‚ùå Missed Photo Only <span class="badge bg-light text-dark" style="min-width: 40px;">{{ count_missed }}</span>
            </a>
        </div>
        <div class="col-md-auto ms-auto">
            <div class="d-flex gap-2">
                <div>
                    <label for="filter-building" class="form-label mb-1 small text-muted">Filter by Building</label>
                    <select id="filter-building" class="form-select form-select-sm">
                        <option value="">All Buildings</option>
                    </select>
                </div>
                <div>
                    <label for="filter-type" class="form-label mb-1 small text-muted">Filter by Type</label>
                    <select id="filter-type" class="form-select form-select-sm">
                        <option value="">All Types</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <table id="assetTable" class="table table-striped table-bordered align-middle text-center w-100">
        <thead class="table-dark">
            <tr>
                <th class="text-center">QR Code</th>
                <th class="text-center">Building</th>
                <th class="text-center">Type</th>
                <th class="text-start">Manufacturer</th>
                <th class="text-start">Model</th>
                <th class="text-start">Serial</th>
                <th class="text-center">Year</th>
                <th class="text-start">UBC Tag</th>
                <th class="text-start">Technical Safety BC</th>
                <th class="text-center">Flagged</th>
                <th class="text-center">Modified</th>
                <th class="text-center">Missed Photo</th>
                <th class="text-center">Action</th>
            </tr>
        </thead>
        <tbody>
        {% for item in data %}
            <tr>
                <td>{{ item.qr_code }}</td>
                <td>{{ item.building }}</td>
                <td>
                    <span class="type-badge"
                          data-type="{{ (item.asset_type or '') | upper | replace('-', '') | trim }}">
                        {{ (item.asset_type or '') | upper | replace('-', '') | trim }}
                    </span>
                </td>
                <td class="text-start">{{ item.Manufacturer }}</td>
                <td class="text-start">{{ item.Model }}</td>
                <td class="text-start">{{ item['Serial Number'] }}</td>
                <td>{{ item.Year }}</td>
                <td class="text-start">{{ item['UBC Tag'] }}</td>
                <td class="text-start">{{ item['Technical Safety BC'] }}</td>
                <td>{% if item.Flagged == 'true' %}üö©{% else %}&mdash;{% endif %}</td>
                <td>{% if item.Modified %}‚úèÔ∏è{% else %}&mdash;{% endif %}</td>
                <td>
                  {% if item['Missed Photo'] == 'YES' %}
                    <span class="text-danger"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="Missing: {{ item['Missing List'] }}">
                      ‚ùå {{ item['Photos Summary'] }}
                    </span>
                  {% else %}
                    <span class="text-success"
                          data-bs-toggle="tooltip"
                          data-bs-placement="top"
                          title="All required present">
                      ‚úÖ 3/3
                    </span>
                  {% endif %}
                </td>
                <td>
                    <a class="btn btn-primary btn-sm" href="{{ url_for('review', doc_id=item.doc_id) }}">Review</a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <footer class="text-center mt-5 pt-4 border-top text-muted small">
        ¬© 2025 University of British Columbia - Maintenance Planning Department. All rights reserved.
    </footer>

    <!-- jQuery, Bootstrap (tooltips), DataTables -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // Activate Bootstrap tooltips
        document.addEventListener('DOMContentLoaded', function () {
          var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
          tooltipTriggerList.map(function (el) { return new bootstrap.Tooltip(el) })
        });

        $(document).ready(function () {
            var table = $('#assetTable').DataTable({
                pageLength: 15,
                order: [],
                columnDefs: [
                    { orderable: true, targets: [0, 1, 2, 4, 6] },
                    { orderable: false, targets: "_all" }
                ]
            });

            // Type badge coloring
            function applyTypeBadges() {
                $('#assetTable span.type-badge').each(function () {
                    var t = ($(this).data('type') || '').toString().trim().toUpperCase();
                    $(this).removeClass(function (idx, cn) {
                        return (cn.match(/(^|\s)type-\S+/g) || []).join(' ');
                    });
                    var cls = 'type-OTHER';
                    if (t === 'ME') cls = 'type-ME';
                    else if (t === 'EE') cls = 'type-EE';
                    else if (t === 'EL') cls = 'type-EL';
                    else if (t === 'PL') cls = 'type-PL';
                    else if (t === 'HV') cls = 'type-HV';
                    $(this).addClass(cls);
                });
            }
            applyTypeBadges();
            table.on('draw', function () {
                applyTypeBadges();
            });

            // Quick filter dropdowns
            var buildingCol = 1;
            var typeCol = 2;

            function populateSelectFromColumn(selectId, colIndex) {
                var select = $(selectId);
                select.find('option:not(:first)').remove();
                var uniques = {};
                table.column(colIndex, { search: 'applied' }).data().each(function (val) {
                    if (colIndex === typeCol) {
                        var div = document.createElement('div');
                        div.innerHTML = val;
                        val = $(div).text().trim();
                    } else {
                        val = (val || '').toString().trim();
                    }
                    if (val) uniques[val] = true;
                });
                Object.keys(uniques).sort().forEach(function (v) {
                    select.append(new Option(v, v));
                });
            }

            populateSelectFromColumn('#filter-building', buildingCol);
            populateSelectFromColumn('#filter-type', typeCol);

            table.on('draw', function () {
                populateSelectFromColumn('#filter-building', buildingCol);
                populateSelectFromColumn('#filter-type', typeCol);
            });

            $('#filter-building').on('change', function () {
                var val = $(this).val();
                table.column(buildingCol).search(val ? '^' + $.fn.dataTable.util.escapeRegex(val) + '$' : '', true, false).draw();
            });
            $('#filter-type').on('change', function () {
                var val = $(this).val();
                table.column(typeCol).search(val || '', false, false).draw();
            });
        });
    </script>

</body>
</html>
